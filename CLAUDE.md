# CLAUDE.md ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –≤–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã –æ –ø—Ä–æ–µ–∫—Ç–µ

## –û–±–∑–æ—Ä

Telegram-–±–æ—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∫–Ω–∏–≥ —Å —Å–∞–π—Ç–∞ Flibusta. –ù–∞–ø–∏—Å–∞–Ω –Ω–∞ Python 3.12, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É `python-telegram-bot` v21+ (async). –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ srv.py          ‚Äî –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞. –ó–∞–≥—Ä—É–∂–∞–µ—Ç .env, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ë–î, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ö—ç–Ω–¥–ª–µ—Ä—ã, –∑–∞–ø—É—Å–∫–∞–µ—Ç polling.
‚îú‚îÄ‚îÄ config.py       ‚Äî –í—Å–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–∞–π—Ç, —Ç–∞–π–º–∞—É—Ç—ã, –ø–∞–≥–∏–Ω–∞—Ü–∏—è, —É—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π, –ø–æ–ª–∫–∏).
‚îú‚îÄ‚îÄ flib.py         ‚Äî –°–∫—Ä–∞–ø–∏–Ω–≥ Flibusta: –ø–æ–∏—Å–∫ –∫–Ω–∏–≥, –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤/–æ–±–ª–æ–∂–µ–∫.
‚îú‚îÄ‚îÄ database.py     ‚Äî SQLite —á–µ—Ä–µ–∑ sqlite3 (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π). –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∏—Å—Ç–æ—Ä–∏—è, –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, —Å–∫–∞—á–∏–≤–∞–Ω–∏—è, –∫—ç—à –∫–Ω–∏–≥.
‚îú‚îÄ‚îÄ tg_bot.py       ‚Äî –õ–æ–≥–∏–∫–∞ –±–æ—Ç–∞: –∫–æ–º–∞–Ω–¥—ã, callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫, UI, –ø–∞–≥–∏–Ω–∞—Ü–∏—è, –Ω–∞–≤–∏–≥–∞—Ü–∏—è.
‚îî‚îÄ‚îÄ custom_logging.py ‚Äî JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å RotatingFileHandler (10 –ú–ë √ó 5 —Ñ–∞–π–ª–æ–≤).
```

## –ö–ª—é—á–µ–≤—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (`src/srv.py`)

- `load_dotenv(".env")` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–¥–æ** –ª—é–±—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –º–æ–¥—É–ª–µ–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö `os.getenv()` –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è (config, tg_bot).
- `db.init_database()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ `main()` –¥–æ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.
- `HTTPXRequest` –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —Å –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (8) –∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏ 20 —Å–µ–∫.
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `TELEGRAM_PROXY`.
- –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ `cleanup_job` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ 03:00 —á–µ—Ä–µ–∑ `job_queue.run_daily()`.

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (`src/database.py`)

- **–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π** `sqlite3` (–Ω–µ aiosqlite). –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî –æ–±—ã—á–Ω—ã–µ (–Ω–µ `async`).
- `get_db()` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä, –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç/–∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
- WAL-—Ä–µ–∂–∏–º –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (`PRAGMA journal_mode=WAL`).
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ `init_database()`: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ `ALTER TABLE` —Å `try/except sqlite3.OperationalError`.
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ JSON-—Å—Ç—Ä–æ–∫–∞ –≤ –∫–æ–ª–æ–Ω–∫–µ `preferences` —Ç–∞–±–ª–∏—Ü—ã `users`.
- –¢–µ–≥–∏ (–ø–æ–ª–∫–∏) –≤ `favorites.tags` ‚Äî —ç—Ç–æ **–ø—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞** (–∫–ª—é—á –∏–∑ `config.FAVORITE_SHELVES`), **–Ω–µ JSON-–º–∞—Å—Å–∏–≤**.

#### –¢–∞–±–ª–∏—Ü—ã

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---|---|
| `users` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (preferences JSON) |
| `search_history` | –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ |
| `favorites` | –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ (UNIQUE –Ω–∞ user_id + book_id) |
| `downloads` | –ò—Å—Ç–æ—Ä–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏–π |
| `books_cache` | –ö—ç—à –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–Ω–∏–≥–∞—Ö (–∞–Ω–Ω–æ—Ç–∞—Ü–∏—è, –∂–∞–Ω—Ä—ã, —Ñ–æ—Ä–º–∞—Ç—ã –∏ —Ç.–¥.) |
| `statistics` | –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ) |

### –°–∫—Ä–∞–ø–∏–Ω–≥ (`src/flib.py`)

- –ì–ª–æ–±–∞–ª—å–Ω—ã–π `requests.Session` —Å retry-—Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π (3 –ø–æ–ø—ã—Ç–∫–∏, backoff 1.0 —Å–µ–∫, —Å—Ç–∞—Ç—É—Å—ã 429/5xx).
- In-memory LRU-–∫—ç—à —Å—Ç—Ä–∞–Ω–∏—Ü (`_PAGE_CACHE`, OrderedDict, TTL 300 —Å–µ–∫, –º–∞–∫—Å. 128 –∑–∞–ø–∏—Å–µ–π).
- `Book` ‚Äî dataclass —Å –ø–æ–ª—è–º–∏: `id`, `title`, `author`, `link`, `formats` (dict), `cover`, `size`, `series`, `year`, `annotation`, `genres` (list), `rating`, `author_link`.
- `formats` ‚Äî dict, –≥–¥–µ –∫–ª—é—á = —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä `"(fb2)"`), –∑–Ω–∞—á–µ–Ω–∏–µ = URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.

#### –ú–µ—Ç–æ–¥—ã –ø–æ–∏—Å–∫–∞

| –§—É–Ω–∫—Ü–∏—è | URL Flibusta | –ß—Ç–æ –∏—â–µ—Ç |
|---|---|---|
| `scrape_books_by_title(text)` | `/booksearch?ask=...&chb=on` | –ö–Ω–∏–≥–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é |
| `scrape_books_by_author(text)` | `/booksearch?ask=...&cha=on` | –ê–≤—Ç–æ—Ä–æ–≤ ‚Üí –∏—Ö –∫–Ω–∏–≥–∏ |
| `scrape_books_mbl(title, author)` | `/makebooklist?ab=ab1&t=...&ln=...&sort=sd2` | –¢–æ—á–Ω—ã–π –ø–æ–∏—Å–∫ |
| `get_book_by_id(book_id)` | `/b/{book_id}/` | –î–µ—Ç–∞–ª–∏ –∫–Ω–∏–≥–∏ |
| `get_other_books_by_author(url)` | –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∞ | –î—Ä—É–≥–∏–µ –∫–Ω–∏–≥–∏ –∞–≤—Ç–æ—Ä–∞ |

- `scrape_books_by_author` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `list[list[Book]]` (—Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–æ–≤ ‚Üí —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ –∫–∞–∂–¥–æ–≥–æ).
- `get_book_by_id` –ø–∞—Ä—Å–∏—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é —Ç—Ä–µ–º—è —Å–ø–æ—Å–æ–±–∞–º–∏ (–∑–∞–≥–æ–ª–æ–≤–æ–∫ "–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è", div.content, –≤—Å–µ `<p>`), –∂–∞–Ω—Ä—ã —á–µ—Ä–µ–∑ `/g/`, —Å–µ—Ä–∏—é —á–µ—Ä–µ–∑ `/sequence/`.

### –ë–æ—Ç (`src/tg_bot.py`)

#### –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞

- `ALLOWED_USERS` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ env `ALLOWED_USERS` (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é). –ï—Å–ª–∏ –ø—É—Å—Ç–æ–π ‚Äî –¥–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –≤—Å–µ—Ö.
- –ü–µ—Ä–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–ø–∏—Å–∫–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è **–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º** (–¥–æ—Å—Ç—É–ø –∫ `/stats`, `/users`).
- –¢—Ä–∏ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞:
  - `@check_access` ‚Äî –¥–ª—è –∫–æ–º–∞–Ω–¥ (—á–µ—Ä–µ–∑ `update.message`).
  - `@check_callback_access` ‚Äî –¥–ª—è callback queries.
  - `@rate_limit(sec)` ‚Äî rate-limiting –ø–æ `context.user_data`.

#### Markdown

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **`ParseMode.MARKDOWN`** (v1), **–Ω–µ** MarkdownV2.
- `_escape_md()` —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ `_`, `*`, `` ` ``, `[` (—Å–∏–º–≤–æ–ª—ã Markdown v1).

#### –ù–∞–≤–∏–≥–∞—Ü–∏—è

- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–π —Å—Ç–µ–∫ –≤ `context.user_data["nav_stack"]` (–º–∞–∫—Å. 10 –∑–∞–ø–∏—Å–µ–π).
- `_push_nav` / `_pop_nav` / `_render_nav_entry` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ "–Ω–∞–∑–∞–¥".
- –¢–∏–ø—ã –∑–∞–ø–∏—Å–µ–π: `results`, `favorites`, `history`, `stats`, `settings`, `search_menu`, `main_menu`.

#### In-memory –∫—ç—à –ø–æ–∏—Å–∫–∞

- `_SEARCH_CACHE` ‚Äî dict —Å TTL (`config.SEARCH_CACHE_TTL_SEC` = 120 —Å–µ–∫, –º–∞–∫—Å. 256 –∑–∞–ø–∏—Å–µ–π).
- –ö–ª—é—á–∏: `title:–∑–∞–ø—Ä–æ—Å`, `author:–∑–∞–ø—Ä–æ—Å`, `exact:title|author`, `inline:–∑–∞–ø—Ä–æ—Å`.

#### Callback data –ø—Ä–æ—Ç–æ–∫–æ–ª

| –ü–∞—Ç—Ç–µ—Ä–Ω | –î–µ–π—Å—Ç–≤–∏–µ |
|---|---|
| `book_{id}` | –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∫–Ω–∏–≥–∏ |
| `page_{n}` | –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ |
| `toggle_favorite_{id}` | –î–æ–±–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ |
| `get_book_by_format_{id}\|{url_encoded_format}` | –°–∫–∞—á–∞—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ |
| `qd_{id}` | –ë—ã—Å—Ç—Ä–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ (—Ñ–æ—Ä–º–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| `send_kindle_{id}` | –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ñ–∞–π–ª –¥–ª—è Kindle |
| `pick_shelf_{id}` | –í—ã–±–æ—Ä –ø–æ–ª–∫–∏ |
| `set_tag_{id}_{tag}` | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∫—É |
| `full_ann_{id}` | –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—É—é –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é |
| `author_books_{id}` | –î—Ä—É–≥–∏–µ –∫–Ω–∏–≥–∏ –∞–≤—Ç–æ—Ä–∞ |
| `sort_title` / `sort_author` / `sort_default` | –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ |
| `show_favorites_{page}` | –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ |
| `fav_book_{id}` | –ö–Ω–∏–≥–∞ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ |
| `shelf_{tag}_{page}` | –ü–æ–ª–∫–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º |
| `search_favs` | –ü–æ–∏—Å–∫ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º (–æ–∂–∏–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥) |
| `export_favs` | –≠–∫—Å–ø–æ—Ä—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ .txt |
| `set_per_page_{n}` | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ |
| `set_format_{fmt}` | –§–æ—Ä–º–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
| `repeat_search` | –ü–æ–≤—Ç–æ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–∏—Å–∫–∞ |
| `main_menu` / `menu_search` / `show_history` / `show_my_stats` / `show_settings` | –ù–∞–≤–∏–≥–∞—Ü–∏—è |
| `nav_back` / `back_to_results` | –ù–∞–∑–∞–¥ –ø–æ —Å—Ç–µ–∫—É |

#### Deep Linking

- `/start book_{id}` ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –∫–Ω–∏–≥–∏ (–¥–ª—è —à–∞—Ä–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ URL `t.me/bot?start=book_123`).

#### Kindle

- Kindle –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–∞–∫ "—Å–∫–∞—á–∞–π –∏ –ø–µ—Ä–µ—à–ª–∏": –±–æ—Ç —Å–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–µ—Ä–µ—Å–ª–∞—Ç—å –Ω–∞ kindle email. SMTP –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–ª—è Kindle: `["epub", "mobi", "pdf", "fb2"]` (`config.KINDLE_FORMATS`).

#### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

- `books_per_page` ‚Äî 5, 10 –∏–ª–∏ 20 (–¥–µ—Ñ–æ–ª—Ç 10).
- `default_format` ‚Äî —Ñ–æ—Ä–º–∞—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–µ—Ñ–æ–ª—Ç `fb2`).
- `kindle_email` ‚Äî email –¥–ª—è Kindle.

#### –£—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π

–û–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ–∏—Å–∫–æ–≤ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π (`config.ACHIEVEMENT_LEVELS`):
üìñ –ù–æ–≤–∏—á–æ–∫ ‚Üí üìö –ß–∏—Ç–∞—Ç–µ–ª—å ‚Üí üìï –ë–∏–±–ª–∏–æ—Ñ–∏–ª ‚Üí üèõ –ö–Ω–∏–≥–æ—á–µ–π ‚Üí üéì –≠—Ä—É–¥–∏—Ç ‚Üí üëë –ú–∞—Å—Ç–µ—Ä.

#### –ü–æ–ª–∫–∏ –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ

–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª–∫–∏ (`config.FAVORITE_SHELVES`):
- `want` ‚Äî üìï –•–æ—á—É –ø—Ä–æ—á–∏—Ç–∞—Ç—å
- `reading` ‚Äî üìó –ß–∏—Ç–∞—é
- `done` ‚Äî üìò –ü—Ä–æ—á–∏—Ç–∞–Ω–æ
- `recommend` ‚Äî üìô –†–µ–∫–æ–º–µ–Ω–¥—É—é

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ |
|---|---|---|
| `TOKEN` | –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ | ‚úÖ |
| `ALLOWED_USERS` | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é | ‚ùå (–±–µ–∑ –Ω–µ—ë –¥–æ—Å—Ç—É–ø –¥–ª—è –≤—Å–µ—Ö) |
| `FLIBUSTA_SITE` | URL —Å–∞–π—Ç–∞ Flibusta | ‚ùå (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://flibusta.is`) |
| `TELEGRAM_PROXY` | URL –ø—Ä–æ–∫—Å–∏ –¥–ª—è Telegram API | ‚ùå |
| `DATA_DIR` | –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –ë–î | ‚ùå (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `./data`) |
| `BOOKS_DIR` | –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –æ–±–ª–æ–∂–µ–∫ | ‚ùå (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `./books`) |
| `LOGS_DIR` | –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –ª–æ–≥–æ–≤ | ‚ùå (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `./logs`) |

## Docker

- –û–±—Ä–∞–∑ –Ω–∞ –±–∞–∑–µ `python:3.12-slim`.
- `PYTHONPATH=/srv`, —Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `/srv`.
- –¢—Ä–∏ volume: `/srv/books`, `/srv/logs`, `/srv/data`.
- Entrypoint: `python src/srv.py`.
- `docker-compose.yml` –º–æ–Ω—Ç–∏—Ä—É–µ—Ç `./books`, `./logs`, `./data` –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.

## –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

1. **–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ë–î ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ.** –û–Ω–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ async-—Ö—ç–Ω–¥–ª–µ—Ä–æ–≤ –Ω–∞–ø—Ä—è–º—É—é (–±–ª–æ–∫–∏—Ä—É—é—Ç event loop). –ü—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω—É–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ aiosqlite –∏–ª–∏ `run_in_executor`.
2. **`_book_from_cache` ‚Äî —Ç–æ–∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è.** –ú–æ–∂–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å HTTP-–∑–∞–ø—Ä–æ—Å –∫ Flibusta (—á–µ—Ä–µ–∑ `flib.get_book_by_id`), –±–ª–æ–∫–∏—Ä—É—è event loop.
3. **Callback data –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ 64 –±–∞–π—Ç–∞–º–∏** (–ª–∏–º–∏—Ç Telegram). –§–æ—Ä–º–∞—Ç –∫–Ω–∏–≥–∏ URL-–∫–æ–¥–∏—Ä—É–µ—Ç—Å—è –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ `|` —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å.
4. **–û—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ —Ñ–æ—Ç–æ) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `_safe_edit_or_send` ‚Äî —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä–æ–µ –∏ —à–ª—ë—Ç –Ω–æ–≤–æ–µ.
5. **–û–±–ª–æ–∂–∫–∏** —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –≤ `{BOOKS_DIR}/{book_id}/cover.jpg` –∏ —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ cron-–∑–∞–¥–∞—á–µ —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π.
6. **Inline mode** –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞), —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Telegram.

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|---|
| `/start` | –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + deep linking |
| `/help` | –°–ø—Ä–∞–≤–∫–∞ |
| `/title <–Ω–∞–∑–≤–∞–Ω–∏–µ>` | –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é |
| `/author <—Ñ–∞–º–∏–ª–∏—è>` | –ü–æ–∏—Å–∫ –ø–æ –∞–≤—Ç–æ—Ä—É |
| `/exact <–Ω–∞–∑–≤ \| –∞–≤—Ç–æ—Ä>` | –¢–æ—á–Ω—ã–π –ø–æ–∏—Å–∫ |
| `/id <–Ω–æ–º–µ—Ä>` | –ö–Ω–∏–≥–∞ –ø–æ ID |
| `/search` | –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ –ø–æ–∏—Å–∫—É |
| `/favorites` | –ò–∑–±—Ä–∞–Ω–Ω–æ–µ |
| `/history` | –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞ |
| `/downloads` | –ò—Å—Ç–æ—Ä–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏–π |
| `/mystats` | –õ–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ |
| `/settings` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ |
| `/setpage <5\|10\|20>` | –ö–Ω–∏–≥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ |
| `/setformat <—Ñ–æ—Ä–º–∞—Ç>` | –§–æ—Ä–º–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
| `/setkindle <email>` | Email Kindle |
| `/clearkindle` | –£–¥–∞–ª–∏—Ç—å email Kindle |
| `/users` | –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∞–¥–º–∏–Ω) |
| `/stats` | –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∞–¥–º–∏–Ω) |

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- `python-telegram-bot[job-queue]` ^21.9 ‚Äî Telegram Bot API
- `python-dotenv` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ .env
- `requests` ‚Äî HTTP-–∫–ª–∏–µ–Ω—Ç –¥–ª—è Flibusta
- `beautifulsoup4` + `lxml` ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ HTML
- `json-log-formatter` ‚Äî JSON-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
